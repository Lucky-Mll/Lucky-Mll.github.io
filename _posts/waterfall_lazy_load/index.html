
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="./css/style.css">
</head>

<body>
    <div class="waterfall">
        <div class="box">
            <img src="./imgs/pic (1).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (2).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (3).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (4).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (5).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (6).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (7).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (8).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (9).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (10).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (11).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (12).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (13).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (14).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (15).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (16).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (17).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (18).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (19).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (20).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (21).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (22).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (23).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (24).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (25).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (26).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (27).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (28).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (29).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (30).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (31).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (32).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (33).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (34).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (35).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (36).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (37).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (38).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (39).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (40).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (41).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (42).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (43).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (44).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (45).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (46).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (47).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (48).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (49).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
        <div class="box">
            <img src="./imgs/pic (50).jpg" alt="">
            <p><span>标签：</span><a href="">明星：</a></p>
        </div>
    </div>
   

    <script>
        window.onresize = window.onload = function () {
            waterfall();
        }
        function waterfall() {
            //取得所有盒子
            var boxes = document.querySelectorAll('.waterfall .box');
            var boxW = boxes[0].offsetWidth;
            var col = Math.floor(window.innerWidth / boxW);
            var heightArray = [];
            for (var i = 0; i < boxes.length; i++) {
                if (i < col) {
                    //第一行
                    boxes[i].style.top = 0;
                    boxes[i].style.left = i * boxW + 'px';
                    heightArray.push(boxes[i].offsetHeight);
                } else {
                    //  ...展开运算符
                    var minH = Math.min(...heightArray);
                    var minIndex = heightArray.indexOf(minH);

                    boxes[i].style.top = minH + 'px';
                    boxes[i].style.left = minIndex * boxW + 'px';
                    heightArray[minIndex] = minH + boxes[i].offsetHeight;

                }
            }
        }

        window.onscroll = function () {
            if (needLoad()) {
                loadData();
            }
        }

        function needLoad() {
            let lastBox = document.querySelector(".box:last-of-type");

            let dist = lastBox.getBoundingClientRect().y;

            //当最后一个盒子的高度距离小于等于可视区的高度，则开始加载数据
            return dist <= window.innerHeight;
        }

        var start;
        function loadData() {
            var now = new Date();
            if (!start || now - start > 1000) {
                start = now;

                //ajax获取数据          //TODO:放在json文件中，每次的请求是一样的？？？
                let xhr = new XMLHttpRequest();

                xhr.open('get', './imgs.json', true);

                xhr.onload = function () {
                    if (this.status >= 200 && this.status < 300) {
                        //取得数据
                        //console.log(this.responseText)
                        let imgs = JSON.parse(this.responseText);

                        var count = 0;
                        imgs.forEach(img => {
                            let pic = new Image();
                            pic.src = img.src;

                            pic.onload = function () {
                                count++;
                                if (count === imgs.length) {
                                    waterfall();
                                }
                            }

                            pic.onerror = function () {
                                count++;
                                if (count === imgs.length) {
                                    waterfall();
                                }
                            }
                        })
                        let boxes = imgs.map(obj => `
                            <div class="box">
                                <img src="${obj.src}" alt="">
                                <p><span>标签：</span><a href="">明星</a></p>
                            </div>
                        `)
                        //console.log(boxes);
                        boxes = boxes.join('');
                        document.querySelector('.waterfall').innerHTML += boxes;
                        //waterfall();
                    } else {
                        //出错了
                    }
                }
                xhr.send();
            }
            //根据数据创建div.box的节点
        }
    </script>
</body>

</html>